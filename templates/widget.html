<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakura Reviews Widget</title>
    
    <!-- Google Rich Snippets - SEO Stars in Search Results -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Product",
        "name": "{{ product_name | default('Product') }}",
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "{{ average_rating }}",
            "reviewCount": "{{ total_count }}",
            "bestRating": "5",
            "worstRating": "1"
        }
        {% if reviews and reviews|length > 0 %},
        "review": [
            {% for review in reviews[:5] %}
            {
                "@type": "Review",
                "author": {
                    "@type": "Person",
                    "name": "{{ review.author | default('Customer') }}"
                },
                "datePublished": "{{ review.date }}",
                "reviewBody": "{{ review.text | replace('"', '\\"') | truncate(200) if review.text else '' }}",
                "reviewRating": {
                    "@type": "Rating",
                    "ratingValue": "{{ review.rating }}",
                    "bestRating": "5",
                    "worstRating": "1"
                }
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
        {% endif %}
    }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1a202c;
        }
        
        .sakura-widget {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .widget-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .review-count-dropdown {
            position: relative;
            cursor: pointer;
        }
        
        .review-count-text {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .review-count-text::after {
            content: '‚ñº';
            font-size: 10px;
            opacity: 0.6;
        }
        
        .review-count-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 280px;
            z-index: 1000;
            padding: 16px;
        }
        
        .review-count-menu.show {
            display: block;
        }
        
        .rating-summary-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .rating-summary-number {
            font-size: 32px;
            font-weight: 700;
            color: #1a202c;
        }
        
        .rating-summary-star {
            font-size: 24px;
            color: #FFD700;
        }
        
        .rating-breakdown {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .rating-breakdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px 0;
        }
        
        .rating-breakdown-item:hover {
            opacity: 0.8;
        }
        
        .rating-breakdown-stars {
            display: flex;
            gap: 2px;
            min-width: 100px;
        }
        
        .rating-breakdown-star {
            font-size: 14px;
        }
        
        .rating-breakdown-star.filled {
            color: #FFD700;
        }
        
        .rating-breakdown-star.unfilled {
            color: #e2e8f0;
        }
        
        .rating-breakdown-progress {
            flex: 1;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .rating-breakdown-progress-bar {
            height: 100%;
            background: #FFD700;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .rating-breakdown-count {
            font-size: 14px;
            color: #718096;
            min-width: 40px;
            text-align: right;
        }
        
        .average-rating {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rating-number {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
        }
        
        .rating-stars {
            display: flex;
            gap: 2px;
        }
        
        .rating-star {
            font-size: 20px;
            color: #FFD700;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        
        .write-review-header-btn {
            background: #ff69b4;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .write-review-header-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .filter-icon-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-icon-btn:hover {
            background: #f7fafc;
            border-color: #ff69b4;
        }
        
        .filter-icon-btn.active {
            background: #f7fafc;
            border-color: #ff69b4;
        }
        
        .sort-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
            padding: 8px 0;
        }
        
        .sort-dropdown.show {
            display: block;
        }
        
        .sort-menu-title {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 4px;
        }
        
        .sort-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #1a202c;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sort-menu-item:hover {
            background: #f7fafc;
        }
        
        .sort-menu-item.active {
            color: #ff69b4;
            font-weight: 600;
        }
        
        .sort-menu-item.active::after {
            content: '‚úì';
            color: #ff69b4;
        }
        
        .sort-menu-footer {
            padding: 8px 16px;
            font-size: 11px;
            color: #a0aec0;
            text-align: center;
            border-top: 1px solid #e2e8f0;
            margin-top: 4px;
        }
        
        .reviews-container {
            padding: 24px;
        }
        
        .review-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .review-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .review-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .reviewer-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff69b4, #8b4a8b);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .reviewer-info {
            flex: 1;
        }
        
        .reviewer-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }
        
        .review-date {
            font-size: 13px;
            color: #718096;
            margin-bottom: 4px;
        }
        
        .review-rating {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }
        
        .star {
            color: #ffd700;
            font-size: 14px;
        }
        
        .rating-number {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }
        
        .review-text {
            color: #4a5568;
            line-height: 1.5;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .review-media {
            margin: 8px 0;
        }
        
        .review-media:empty {
            display: none;
        }
        
        .media-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .review-media-slider:empty,
        .review-media-slider.no-photos:empty {
            display: none;
        }
        
        .media-item {
            /* Amazon-style small thumbnails - max 80px, not full width */
            width: 72px;
            height: 72px;
            min-width: 72px;
            max-width: 72px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        
        .media-item:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-color: #ff69b4;
        }
        
        .media-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* Slightly larger thumbnails for reviews with only 1-2 photos */
        .media-grid.few-photos .media-item {
            width: 100px;
            height: 100px;
            min-width: 100px;
            max-width: 100px;
        }
        
        .review-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .meta-badge.ai-recommended {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
        }
        
        /* Review Actions - Helpful & Share */
        .review-actions {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f1f5f9;
            gap: 12px;
        }
        
        .helpful-section {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .share-section {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .helpful-label {
            font-size: 12px;
            color: #64748b;
        }
        
        .helpful-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid #ffffff;
            background: white;
            cursor: pointer;
            font-size: 13px;
            color: #64748b;
            transition: all 0.2s ease;
        }
        
        .helpful-btn:hover {
            background: #f8fafc;
            border-color: #ff69b4;
            color: #ff69b4;
        }
        
        .helpful-btn.voted {
            background: #fdf2f8;
            border-color: #ff69b4;
            color: #ff69b4;
        }
        
        .helpful-count {
            font-weight: 600;
        }
        
        .share-btn {
            background: white;
            color: #ff69b4;
            border: none;
            border-radius: 8px;
            padding: 5px 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 1px;
        }
        
        .share-btn:hover {
            opacity: 0.8;
        }
        
        .share-btn[data-platform="facebook"]:hover {
            background: #1877f2;
            color: white;
        }
        
        .share-btn[data-platform="twitter"]:hover {
            background: #000;
            color: white;
        }
        
        .share-btn[data-platform="copy"]:hover {
            background: #10b981;
            color: white;
        }
        
        /* Toast notification for copy */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a202c;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
        }
        
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        @keyframes toastOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Photo Modal/Lightbox - Loox-inspired stable full-page modal */
        .photo-modal-overlay {
            display: none;
            position: fixed;
            inset: 0px;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2147483646;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            overflow-x: hidden;
            font-family: Arial, Helvetica, sans-serif;
            opacity: 0;
            transition: opacity 400ms ease-in;
        }
        
        .photo-modal-overlay.show {
            display: flex;
            opacity: 1;
        }
        
        .photo-modal {
            position: relative;
            min-height: 100vh;
            width: 100%;
            max-width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            box-sizing: border-box;
            margin: 0 auto;
        }
        
        .photo-modal-content {
            display: flex;
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
        }
        
        .photo-modal-left {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .photo-modal-review-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .photo-modal-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff69b4, #8b4a8b);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .photo-modal-reviewer-info {
            flex: 1;
        }
        
        .photo-modal-reviewer-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .photo-modal-review-date {
            font-size: 14px;
            color: #718096;
        }
        
        .photo-modal-rating {
            display: flex;
            gap: 2px;
            margin: 16px 0;
        }
        
        .photo-modal-star {
            color: #ffd700;
            font-size: 18px;
        }
        
        .photo-modal-text {
            color: #4a5568;
            line-height: 1.7;
            margin: 16px 0;
            font-size: 15px;
            flex: 1;
        }
        
        .photo-modal-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: auto;
            padding-top: 16px;
        }
        
        .photo-modal-right {
            width: 500px;
            min-width: 500px;
            position: relative;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-modal-slider-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 500px;
            overflow: hidden;
        }
        
        .photo-modal-slider-wrapper {
            display: flex;
            transition: transform 0.4s ease;
            height: 100%;
        }
        
        .photo-modal-slide {
            min-width: 100%;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .photo-modal-slide img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        .photo-modal-slider-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 50%;
            font-size: 24px;
            color: #1a202c;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .photo-modal-slider-nav:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateY(-50%) scale(1.1);
        }
        
        .photo-modal-slider-nav.prev {
            left: 16px;
        }
        
        .photo-modal-slider-nav.next {
            right: 16px;
        }
        
        .photo-modal-slider-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .photo-modal-slider-dots {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        
        .photo-modal-slider-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .photo-modal-slider-dot.active {
            background: white;
            width: 24px;
            border-radius: 4px;
        }
        
        .photo-modal-close {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 50%;
            font-size: 24px;
            color: #1a202c;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2147483647;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .photo-modal-close:hover {
            background: white;
            transform: scale(1.1);
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .photo-modal {
                padding: 20px;
            }
            
            .photo-modal-content {
                flex-direction: column;
                max-height: 95vh;
            }
            
            .photo-modal-left {
                padding: 20px;
                max-height: 40vh;
            }
            
            .photo-modal-right {
                width: 100%;
                min-width: 100%;
                height: 60vh;
            }
            
            .photo-modal-slider-container {
                min-height: 60vh;
            }
            
            .photo-modal-close {
                top: 10px;
                right: 10px;
                width: 36px;
                height: 36px;
                font-size: 20px;
            }
        }
        
        .review-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 12px;
        }
        
        .meta-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .verified {
            background: #48bb78;
            color: white;
        }
        
        .ai-recommended {
            background: #4299e1;
            color: white;
        }
        
        .quality-score {
            background: #ed8936;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #e53e3e;
        }
        
        #load-more-container {
            text-align: center;
            margin-top: 24px;
        }
        
        #load-more-btn {
            background: linear-gradient(135deg, #ff69b4, #8b4a8b);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #load-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 105, 180, 0.3);
        }
        
        #load-more-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Review Wizard Modal */
        .review-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .review-modal-overlay.show {
            display: flex;
        }
        
        .review-modal {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-close {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 24px;
            color: #718096;
            z-index: 10;
        }
        
        .modal-close:hover {
            color: #1a202c;
        }
        
        .modal-content {
            padding: 48px 32px 32px;
        }
        
        .modal-step {
            display: none;
        }
        
        .modal-step.active {
            display: block;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .modal-subtitle {
            font-size: 16px;
            color: #718096;
            margin-bottom: 32px;
            text-align: center;
        }
        
        /* Step 1: Rating */
        .rating-wizard-stars {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 32px 0;
        }
        
        .rating-wizard-star {
            font-size: 48px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .rating-wizard-star:hover,
        .rating-wizard-star.filled {
            color: #FFD700;
            transform: scale(1.1);
        }
        
        .rating-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
            color: #718096;
        }
        
        /* Step 2: Photos */
        .photo-upload-area {
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 24px 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .photo-upload-area:hover {
            border-color: #ff69b4;
            background: #fef5f9;
        }
        
        .photo-upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .photo-upload-text {
            font-size: 16px;
            color: #1a202c;
            margin-bottom: 8px;
        }
        
        .photo-upload-hint {
            font-size: 14px;
            color: #718096;
        }
        
        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        .photo-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .offer-box {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 24px 0;
            text-align: center;
        }
        
        .offer-text {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 16px;
        }
        
        .add-photos-btn {
            background: #ff69b4;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .add-photos-btn:hover {
            opacity: 0.9;
        }
        
        /* Step 3: Review Text */
        .review-textarea {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            margin: 24px 0;
        }
        
        .review-textarea:focus {
            outline: none;
            border-color: #ff69b4;
        }
        
        /* Step 4: User Info */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }
        
        .form-label .required {
            color: #e53e3e;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #ff69b4;
        }
        
        .form-disclaimer {
            font-size: 12px;
            color: #718096;
            margin-top: 16px;
            line-height: 1.6;
        }
        
        .form-disclaimer a {
            color: #ff69b4;
            text-decoration: underline;
        }
        
        /* Modal Navigation */
        .modal-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
        }
        
        .modal-nav-btn {
            background: transparent;
            border: none;
            color: #1a202c;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
        }
        
        .modal-nav-btn:hover {
            color: #ff69b4;
        }
        
        .modal-nav-btn.primary {
            background: #ff69b4;
            color: white;
            border-radius: 8px;
        }
        
        .modal-nav-btn.primary:hover {
            opacity: 0.9;
        }
        
        .modal-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-indicator {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 16px;
        }
        
        .progress-bar {
            width: 40px;
            height: 4px;
            border-radius: 2px;
            background: #e2e8f0;
        }
        
        .progress-bar.active {
            background: #ff69b4;
        }
        
        /* Confirmation Modal */
        .confirmation-modal {
            text-align: center;
        }
        
        .confirmation-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #48bb78;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 24px;
        }
        
        .confirmation-text {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }
        
        .confirmation-subtext {
            font-size: 14px;
            color: #718096;
            margin-bottom: 32px;
        }
        
        .referral-box {
            background: #ff69b4;
            color: white;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }
        
        .referral-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .referral-illustration {
            margin: 16px 0;
            font-size: 48px;
        }
        
        .referral-terms {
            font-size: 12px;
            margin-top: 16px;
            opacity: 0.9;
        }
        
        .referral-terms a {
            color: white;
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .widget-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .review-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .review-modal {
                width: 95%;
                max-height: 95vh;
            }
            
            .modal-content {
                padding: 40px 24px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="sakura-widget">
        {% if reviews and reviews|length > 0 %}
        <div class="widget-header">
            <div class="header-left">
                <div class="review-count-dropdown" id="reviewCountDropdown">
                    <div class="review-count-text">
                        {{ total_count }} Review{{ 's' if total_count != 1 else '' }}
                    </div>
                    <div class="review-count-menu" id="reviewCountMenu">
                        <div class="rating-summary-header">
                            <span class="rating-summary-number">{{ "%.1f"|format(average_rating) }}</span>
                            <span class="rating-summary-star">‚òÖ</span>
                        </div>
                        <div class="rating-breakdown">
                            {% for rating in range(5, 0, -1) %}
                            {% set count = rating_distribution.get(rating, 0) %}
                            {% set percentage = (count / total_count * 100) if total_count > 0 else 0 %}
                            <div class="rating-breakdown-item" data-rating="{{ rating }}">
                                <div class="rating-breakdown-stars">
                                    {% for i in range(5) %}
                                        {% if i < rating %}
                                            <span class="rating-breakdown-star filled">‚òÖ</span>
                                        {% else %}
                                            <span class="rating-breakdown-star unfilled">‚òÜ</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="rating-breakdown-progress">
                                    <div class="rating-breakdown-progress-bar" style="width: {{ percentage }}%;"></div>
                                </div>
                                <div class="rating-breakdown-count">({{ count }})</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="average-rating">
                    <span class="rating-number">{{ "%.1f"|format(average_rating) }}</span>
                    <div class="rating-stars">
                        {% set full_stars = average_rating|int %}
                        {% set has_half = (average_rating - full_stars) >= 0.5 %}
                        {% for i in range(5) %}
                            {% if i < full_stars %}
                                <span class="rating-star">‚òÖ</span>
                            {% elif i == full_stars and has_half %}
                                <span class="rating-star" style="opacity: 0.5;">‚òÖ</span>
                            {% else %}
                                <span class="rating-star" style="opacity: 0.2;">‚òÜ</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="write-review-header-btn" id="writeReviewBtn">
                    Write a review
                </button>
                <div class="filter-icon-btn" id="filterIconBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="4" y1="6" x2="20" y2="6"></line>
                        <line x1="4" y1="12" x2="20" y2="12"></line>
                        <line x1="4" y1="18" x2="20" y2="18"></line>
                        <circle cx="7" cy="6" r="2"></circle>
                        <circle cx="12" cy="12" r="2"></circle>
                        <circle cx="17" cy="18" r="2"></circle>
                    </svg>
                </div>
                <div class="sort-dropdown" id="sortDropdown">
                    <div class="sort-menu-title">Sort by</div>
                    <div class="sort-menu-item {% if current_sort == 'ai_recommended' %}active{% endif %}" data-sort="ai_recommended">AI recommended</div>
                    <div class="sort-menu-item {% if current_sort == 'newest' %}active{% endif %}" data-sort="newest">Newest</div>
                    <div class="sort-menu-item {% if current_sort == 'highest_ratings' %}active{% endif %}" data-sort="highest_ratings">Highest Ratings</div>
                    <div class="sort-menu-item {% if current_sort == 'lowest_ratings' %}active{% endif %}" data-sort="lowest_ratings">Lowest Ratings</div>
                    <div class="sort-menu-footer">Powered by Sakura Reviews</div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="reviews-container">
            {% if reviews and reviews|length > 0 %}
                {% for review in reviews %}
                <div class="review-card" data-review-id="{{ review.id }}">
                    <div class="review-header">
                        <div class="reviewer-avatar">
                            {{ review.author[0] if review.author else 'C' }}
                        </div>
                        <div class="reviewer-info">
                            <div class="reviewer-name">{{ review.author or 'Anonymous' }}</div>
                            <div class="review-date">{{ review.date }}</div>
                            <div class="review-rating">
                                {% for i in range(review.rating) %}
                                    <span class="star">‚òÖ</span>
                                {% endfor %}
                                <span class="rating-number">({{ review.rating }})</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="review-text">
                        {{ review.text }}
                    </div>
                    
                    {% if review.media and review.media|length > 0 %}
                    <div class="review-media">
                        <div class="media-grid{% if review.media|length <= 2 %} few-photos{% endif %}">
                            {% for media in review.media %}
                            <div class="media-item" title="Click to enlarge">
                                <img src="{{ media.media_url }}" alt="Review photo" loading="lazy" class="review-photo" data-photo-url="{{ media.media_url }}" data-review-id="{{ review.id }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="review-meta">
                        {% if review.verified %}
                        <span class="meta-badge verified">‚úì Verified</span>
                        {% endif %}
                        {% if review.ai_recommended %}
                        <span class="meta-badge ai-recommended">üå∏ AI Recommended</span>
                        {% endif %}
                    </div>
                    
                    <!-- Helpful & Share Actions -->
                    <div class="review-actions">
                        <div class="helpful-section">
                            <span class="helpful-label">Was this helpful?</span>
                            <button class="helpful-btn" data-review-id="{{ review.id }}" data-vote="yes" title="Yes, helpful">
                                üëç <span class="helpful-count">{{ review.helpful_yes | default(0) }}</span>
                            </button>
                        </div>
                        <div class="share-section">
                            <span style="color: #a7a1a1;">‚Ä¢ </span>
                            <button class="share-btn" data-platform="facebook" data-review-id="{{ review.id }}" title="Share on Facebook">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
                            </button>
                            <button class="share-btn" data-platform="twitter" data-review-id="{{ review.id }}" title="Share on Twitter/X">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                            </button>
                            <button class="share-btn" data-platform="copy" data-review-id="{{ review.id }}" title="Copy link">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if total_count > reviews|length %}
                <div id="load-more-container">
                    <button id="load-more-btn">Load More Reviews</button>
                </div>
                {% endif %}
            {% else %}
                <div class="loading">
                    <p>No reviews yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Review Wizard Modal -->
    <div class="review-modal-overlay" id="reviewModalOverlay">
        <div class="review-modal">
            <button class="modal-close" id="modalClose">√ó</button>
            <div class="modal-content">
                <!-- Step 1: Rating -->
                <div class="modal-step active" id="step1">
                    <h2 class="modal-title">How would you rate this item?</h2>
                    <div class="rating-wizard-stars" id="ratingStars">
                        <span class="rating-wizard-star" data-rating="1">‚òÖ</span>
                        <span class="rating-wizard-star" data-rating="2">‚òÖ</span>
                        <span class="rating-wizard-star" data-rating="3">‚òÖ</span>
                        <span class="rating-wizard-star" data-rating="4">‚òÖ</span>
                        <span class="rating-wizard-star" data-rating="5">‚òÖ</span>
                    </div>
                    <div class="rating-labels">
                        <span>Dislike it</span>
                        <span>Love it!</span>
                    </div>
                    <div class="modal-navigation">
                        <button class="modal-nav-btn" id="step1Next" disabled>Next ‚Üí</button>
                    </div>
                </div>
                
                <!-- Step 2: Photos -->
                <div class="modal-step" id="step2">
                    <h2 class="modal-title">Show it off</h2>
                    <p class="modal-subtitle">We'd love to see it in action!</p>
                    <div class="offer-box">
                        <div class="offer-text">Get 15% off your next purchase!</div>
                        <div class="photo-upload-area" id="photoUploadArea">
                            <div class="photo-upload-icon">üì∑</div>
                            <div class="photo-upload-text">Add photos</div>
                            <div class="photo-upload-hint">Click to upload or drag and drop</div>
                            <input type="file" id="photoInput" multiple accept="image/*" style="display: none;">
                        </div>
                        <div class="photo-preview-grid" id="photoPreviewGrid"></div>
                    </div>
                    <div class="modal-navigation">
                        <button class="modal-nav-btn" id="step2Back">‚Üê Back</button>
                        <button class="modal-nav-btn" id="step2Skip">Skip</button>
                        <button class="modal-nav-btn primary" id="step2Next">Next ‚Üí</button>
                    </div>
                </div>
                
                <!-- Step 3: Review Text -->
                <div class="modal-step" id="step3">
                    <h2 class="modal-title">Tell us more!</h2>
                    <textarea class="review-textarea" id="reviewText" placeholder="Share your experience"></textarea>
                    <div class="modal-navigation">
                        <button class="modal-nav-btn" id="step3Back">‚Üê Back</button>
                        <button class="modal-nav-btn primary" id="step3Next">Next ‚Üí</button>
                    </div>
                </div>
                
                <!-- Step 4: User Info -->
                <div class="modal-step" id="step4">
                    <h2 class="modal-title">About you</h2>
                    <div class="form-group">
                        <label class="form-label">First name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last name</label>
                        <input type="text" class="form-input" id="lastName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="required">*</span></label>
                        <input type="email" class="form-input" id="userEmail" required>
                    </div>
                    <div class="form-disclaimer">
                        By submitting, I acknowledge the <a href="#" target="_blank">Terms of Service</a> and <a href="#" target="_blank">Privacy Policy</a>. and that my review will be publicly posted and shared online.
                    </div>
                    <div class="modal-navigation">
                        <button class="modal-nav-btn" id="step4Back">‚Üê Back</button>
                        <button class="modal-nav-btn primary" id="step4Done">Done</button>
                    </div>
                </div>
                
                <!-- Step 5: Confirmation -->
                <div class="modal-step" id="step5">
                    <div class="confirmation-modal">
                        <div class="confirmation-icon">‚úì</div>
                        <div class="confirmation-text">Review submitted</div>
                        <div class="confirmation-subtext">Discount code emailed</div>
                        
                        <div class="referral-box">
                            <div class="referral-title">Give your friends a 10% discount, earn $5 when they buy</div>
                            <div class="referral-illustration">ü§ù</div>
                            <button class="share-btn" id="shareDiscountBtn">Share discount link</button>
                            <div class="referral-terms">Minimum purchase amount: $50 | <a href="#" target="_blank">Terms of Service</a></div>
                        </div>
                        
                        <div class="modal-navigation">
                            <button class="modal-nav-btn primary" id="step5Close" style="width: 100%;">Close</button>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Indicator -->
                <div class="progress-indicator">
                    <div class="progress-bar active" id="progress1"></div>
                    <div class="progress-bar" id="progress2"></div>
                    <div class="progress-bar" id="progress3"></div>
                    <div class="progress-bar" id="progress4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const shopId = '{{ shop_id }}';
        const productId = '{{ product_id }}';
        const currentSort = '{{ current_sort }}';
        
        // Dropdown management
        function closeAllDropdowns() {
            const reviewMenu = document.getElementById('reviewCountMenu');
            const sortDropdown = document.getElementById('sortDropdown');
            const filterBtn = document.getElementById('filterIconBtn');
            
            if (reviewMenu) reviewMenu.classList.remove('show');
            if (sortDropdown) sortDropdown.classList.remove('show');
            if (filterBtn) filterBtn.classList.remove('active');
        }
        
        // Review count dropdown
        const reviewCountDropdown = document.getElementById('reviewCountDropdown');
        if (reviewCountDropdown) {
            reviewCountDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                const menu = document.getElementById('reviewCountMenu');
                if (menu) {
                    const isOpen = menu.classList.contains('show');
                    closeAllDropdowns();
                    if (!isOpen) {
                        menu.classList.add('show');
                    }
                }
            });
        }
        
        // Filter icon and sort dropdown
        const filterIconBtn = document.getElementById('filterIconBtn');
        if (filterIconBtn) {
            filterIconBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const dropdown = document.getElementById('sortDropdown');
                if (dropdown) {
                    const isOpen = dropdown.classList.contains('show');
                    closeAllDropdowns();
                    if (!isOpen) {
                        dropdown.classList.add('show');
                        this.classList.add('active');
                    }
                }
            });
        }
        
        // Sort menu item clicks
        document.querySelectorAll('.sort-menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                const sort = this.getAttribute('data-sort');
                if (sort && sort !== currentSort) {
                    // Reload widget with new sort
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('sort', sort);
                    window.location.href = currentUrl.toString();
                } else {
                    closeAllDropdowns();
                }
            });
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.review-count-dropdown') && 
                !e.target.closest('.filter-icon-btn') && 
                !e.target.closest('.sort-dropdown')) {
                closeAllDropdowns();
            }
        });
        
        // Review Wizard State
        let currentStep = 1;
        let reviewData = {
            rating: 0,
            photos: [],
            text: '',
            firstName: '',
            lastName: '',
            email: ''
        };
        
        // Open Review Modal
        const writeReviewBtn = document.getElementById('writeReviewBtn');
        const reviewModalOverlay = document.getElementById('reviewModalOverlay');
        const modalClose = document.getElementById('modalClose');
        
        if (writeReviewBtn) {
            writeReviewBtn.addEventListener('click', function() {
                reviewModalOverlay.classList.add('show');
                currentStep = 1;
                reviewData = { rating: 0, photos: [], text: '', firstName: '', lastName: '', email: '' };
                showStep(1);
            });
        }
        
        if (modalClose) {
            modalClose.addEventListener('click', function() {
                closeModal();
            });
        }
        
        if (reviewModalOverlay) {
            reviewModalOverlay.addEventListener('click', function(e) {
                if (e.target === reviewModalOverlay) {
                    closeModal();
                }
            });
        }
        
        function closeModal() {
            reviewModalOverlay.classList.remove('show');
        }
        
        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.modal-step').forEach(s => s.classList.remove('active'));
            
            // Show current step
            const stepElement = document.getElementById(`step${step}`);
            if (stepElement) {
                stepElement.classList.add('active');
            }
            
            // Update progress bars
            for (let i = 1; i <= 4; i++) {
                const progressBar = document.getElementById(`progress${i}`);
                if (progressBar) {
                    if (i <= step) {
                        progressBar.classList.add('active');
                    } else {
                        progressBar.classList.remove('active');
                    }
                }
            }
            
            currentStep = step;
        }
        
        // Step 1: Rating Selection
        const ratingStars = document.querySelectorAll('.rating-wizard-star');
        const step1Next = document.getElementById('step1Next');
        
        ratingStars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                reviewData.rating = rating;
                
                // Update star display
                ratingStars.forEach((s, index) => {
                    if (index < rating) {
                        s.classList.add('filled');
                    } else {
                        s.classList.remove('filled');
                    }
                });
                
                // Enable Next button
                if (step1Next) {
                    step1Next.disabled = false;
                }
            });
        });
        
        if (step1Next) {
            step1Next.addEventListener('click', function() {
                if (reviewData.rating > 0) {
                    showStep(2);
                }
            });
        }
        
        // Step 2: Photo Upload
        const photoUploadArea = document.getElementById('photoUploadArea');
        const photoInput = document.getElementById('photoInput');
        const photoPreviewGrid = document.getElementById('photoPreviewGrid');
        const step2Back = document.getElementById('step2Back');
        const step2Skip = document.getElementById('step2Skip');
        const step2Next = document.getElementById('step2Next');
        
        if (photoUploadArea && photoInput) {
            photoUploadArea.addEventListener('click', function() {
                photoInput.click();
            });
            
            photoInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            reviewData.photos.push({
                                file: file,
                                preview: event.target.result
                            });
                            updatePhotoPreview();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });
        }
        
        function updatePhotoPreview() {
            if (photoPreviewGrid) {
                photoPreviewGrid.innerHTML = '';
                reviewData.photos.forEach((photo, index) => {
                    const item = document.createElement('div');
                    item.className = 'photo-preview-item';
                    item.innerHTML = `
                        <img src="${photo.preview}" alt="Preview">
                        <button class="photo-remove" onclick="removePhoto(${index})">√ó</button>
                    `;
                    photoPreviewGrid.appendChild(item);
                });
            }
        }
        
        window.removePhoto = function(index) {
            reviewData.photos.splice(index, 1);
            updatePhotoPreview();
        };
        
        if (step2Back) {
            step2Back.addEventListener('click', function() {
                showStep(1);
            });
        }
        
        if (step2Skip) {
            step2Skip.addEventListener('click', function() {
                showStep(3);
            });
        }
        
        if (step2Next) {
            step2Next.addEventListener('click', function() {
                showStep(3);
            });
        }
        
        // Step 3: Review Text
        const reviewText = document.getElementById('reviewText');
        const step3Back = document.getElementById('step3Back');
        const step3Next = document.getElementById('step3Next');
        
        if (reviewText) {
            reviewText.addEventListener('input', function() {
                reviewData.text = this.value;
            });
        }
        
        if (step3Back) {
            step3Back.addEventListener('click', function() {
                showStep(2);
            });
        }
        
        if (step3Next) {
            step3Next.addEventListener('click', function() {
                showStep(4);
            });
        }
        
        // Step 4: User Info
        const firstName = document.getElementById('firstName');
        const lastName = document.getElementById('lastName');
        const userEmail = document.getElementById('userEmail');
        const step4Back = document.getElementById('step4Back');
        const step4Done = document.getElementById('step4Done');
        
        if (firstName) {
            firstName.addEventListener('input', function() {
                reviewData.firstName = this.value;
            });
        }
        
        if (lastName) {
            lastName.addEventListener('input', function() {
                reviewData.lastName = this.value;
            });
        }
        
        if (userEmail) {
            userEmail.addEventListener('input', function() {
                reviewData.email = this.value;
            });
        }
        
        if (step4Back) {
            step4Back.addEventListener('click', function() {
                showStep(3);
            });
        }
        
        if (step4Done) {
            step4Done.addEventListener('click', async function() {
                // Validate required fields
                if (!reviewData.firstName || !reviewData.email) {
                    alert('Please fill in all required fields (First name and Email)');
                    return;
                }
                
                // Submit review
                this.disabled = true;
                this.textContent = 'Submitting...';
                
                try {
                    const formData = new FormData();
                    formData.append('shopify_product_id', productId);
                    formData.append('rating', reviewData.rating);
                    formData.append('text', reviewData.text);
                    formData.append('reviewer_name', `${reviewData.firstName} ${reviewData.lastName}`.trim());
                    formData.append('reviewer_email', reviewData.email);
                    
                    // Add photos
                    reviewData.photos.forEach((photo, index) => {
                        formData.append(`photo_${index}`, photo.file);
                    });
                    
                    const response = await fetch(`/widget/${shopId}/reviews/${productId}/submit`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showStep(5);
                    } else {
                        alert('Failed to submit review: ' + (result.error || 'Unknown error'));
                        this.disabled = false;
                        this.textContent = 'Done';
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                    alert('Error submitting review. Please try again.');
                    this.disabled = false;
                    this.textContent = 'Done';
                }
            });
        }
        
        // Step 5: Confirmation
        const step5Close = document.getElementById('step5Close');
        const shareDiscountBtn = document.getElementById('shareDiscountBtn');
        
        if (step5Close) {
            step5Close.addEventListener('click', function() {
                closeModal();
                // Reload page to show new review
                window.location.reload();
            });
        }
        
        if (shareDiscountBtn) {
            shareDiscountBtn.addEventListener('click', function() {
                // Generate referral link (placeholder)
                const referralLink = `${window.location.origin}/referral/${shopId}?ref=${reviewData.email}`;
                if (navigator.share) {
                    navigator.share({
                        title: 'Get 10% off!',
                        text: 'Check out this store and get 10% off your purchase!',
                        url: referralLink
                    });
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(referralLink).then(() => {
                        alert('Referral link copied to clipboard!');
                    });
                }
            });
        }
        
        // Auto-resize iframe
        function resizeIframe() {
            const height = document.body.scrollHeight;
            window.parent.postMessage({
                type: 'resize',
                height: height
            }, '*');
        }
        
        // Resize on load and when content changes
        window.addEventListener('load', resizeIframe);
        window.addEventListener('resize', resizeIframe);
        
        // Photo Modal/Lightbox
        let currentPhotoIndex = 0;
        let currentPhotos = [];
        
        // Create photo modal HTML with two-column layout
        const photoModalHTML = `
            <div class="photo-modal-overlay" id="photoModalOverlay">
                <button class="photo-modal-close" id="photoModalClose">√ó</button>
                <div class="photo-modal" id="photoModal">
                    <div class="photo-modal-content">
                        <div class="photo-modal-left" id="photoModalLeft">
                            <!-- Review details will be populated here -->
                        </div>
                        <div class="photo-modal-right">
                            <div class="photo-modal-slider-container" id="photoModalSliderContainer">
                                <div class="photo-modal-slider-wrapper" id="photoModalSliderWrapper">
                                    <!-- Slides will be populated here -->
                                </div>
                                <button class="photo-modal-slider-nav prev" id="photoModalSliderPrev" aria-label="Previous photo">‚Äπ</button>
                                <button class="photo-modal-slider-nav next" id="photoModalSliderNext" aria-label="Next photo">‚Ä∫</button>
                                <div class="photo-modal-slider-dots" id="photoModalSliderDots"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', photoModalHTML);
        
        const photoModalOverlay = document.getElementById('photoModalOverlay');
        const photoModalLeft = document.getElementById('photoModalLeft');
        const photoModalSliderWrapper = document.getElementById('photoModalSliderWrapper');
        const photoModalSliderPrev = document.getElementById('photoModalSliderPrev');
        const photoModalSliderNext = document.getElementById('photoModalSliderNext');
        const photoModalSliderDots = document.getElementById('photoModalSliderDots');
        const photoModalClose = document.getElementById('photoModalClose');
        
        let currentReviewData = null;
        
        function openPhotoModal(photoUrl, allPhotos, startIndex, reviewData = null) {
            currentPhotos = allPhotos;
            currentPhotoIndex = startIndex;
            currentReviewData = reviewData;
            
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';
            
            // Show overlay first
            photoModalOverlay.classList.add('show');
            
            // Update modal content
            updatePhotoModal();
        }
        
        function closePhotoModal() {
            photoModalOverlay.classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
        }
        
        function updatePhotoModal() {
            if (currentPhotos.length === 0) return;
            
            // Update left column with review details
            if (currentReviewData && photoModalLeft) {
                let stars = '';
                for (let i = 0; i < (currentReviewData.rating || 5); i++) {
                    stars += '<span class="photo-modal-star">‚òÖ</span>';
                }
                
                let verifiedBadge = '';
                if (currentReviewData.verified) {
                    verifiedBadge = '<span class="meta-badge verified">‚úì Verified</span>';
                }
                
                const reviewerName = currentReviewData.author || currentReviewData.reviewer_name || 'Anonymous';
                const reviewerInitial = reviewerName[0] || 'C';
                const reviewDate = currentReviewData.date || currentReviewData.review_date || '';
                const reviewText = currentReviewData.text || currentReviewData.body || '';
                
                photoModalLeft.innerHTML = `
                    <div class="photo-modal-review-header">
                        <div class="photo-modal-avatar">${reviewerInitial}</div>
                        <div class="photo-modal-reviewer-info">
                            <div class="photo-modal-reviewer-name">${reviewerName}</div>
                            <div class="photo-modal-review-date">${reviewDate}</div>
                        </div>
                    </div>
                    <div class="photo-modal-rating">${stars}</div>
                    <div class="photo-modal-text">${reviewText}</div>
                    <div class="photo-modal-meta">${verifiedBadge}</div>
                `;
            }
            
            // Update right column with photo slider
            if (photoModalSliderWrapper) {
                photoModalSliderWrapper.innerHTML = currentPhotos.map((photo, index) => `
                    <div class="photo-modal-slide">
                        <img src="${photo.url}" alt="Review photo" loading="lazy">
                    </div>
                `).join('');
                
                // Update dots
                if (photoModalSliderDots) {
                    photoModalSliderDots.innerHTML = currentPhotos.map((_, index) => `
                        <span class="photo-modal-slider-dot ${index === currentPhotoIndex ? 'active' : ''}" data-index="${index}"></span>
                    `).join('');
                }
                
                // Update slider position
                updateModalSlider();
            }
        }
        
        function updateModalSlider() {
            if (!photoModalSliderWrapper) return;
            
            const translateX = -currentPhotoIndex * 100;
            photoModalSliderWrapper.style.transform = `translateX(${translateX}%)`;
            
            // Update dots
            const dots = photoModalSliderDots.querySelectorAll('.photo-modal-slider-dot');
            dots.forEach((dot, index) => {
                if (index === currentPhotoIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
            
            // Update nav buttons
            if (photoModalSliderPrev) {
                photoModalSliderPrev.disabled = currentPhotoIndex === 0;
            }
            if (photoModalSliderNext) {
                photoModalSliderNext.disabled = currentPhotoIndex === currentPhotos.length - 1;
            }
        }
        
        function showPrevPhoto() {
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                updateModalSlider();
            }
        }
        
        function showNextPhoto() {
            if (currentPhotoIndex < currentPhotos.length - 1) {
                currentPhotoIndex++;
                updateModalSlider();
            }
        }
        
        // Close modal handlers
        if (photoModalClose) {
            photoModalClose.addEventListener('click', closePhotoModal);
        }
        
        if (photoModalOverlay) {
            photoModalOverlay.addEventListener('click', function(e) {
                if (e.target === photoModalOverlay) {
                    closePhotoModal();
                }
            });
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (!photoModalOverlay || !photoModalOverlay.classList.contains('show')) return;
            
            if (e.key === 'Escape') {
                closePhotoModal();
            } else if (e.key === 'ArrowLeft') {
                showPrevPhoto();
            } else if (e.key === 'ArrowRight') {
                showNextPhoto();
            }
        });
        
        // Touch/swipe support for modal slider
        if (photoModalSliderWrapper) {
            let touchStartX = 0;
            let touchEndX = 0;
            
            photoModalSliderWrapper.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            photoModalSliderWrapper.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        showNextPhoto(); // Swipe left = next
                    } else {
                        showPrevPhoto(); // Swipe right = prev
                    }
                }
            });
        }
        
        // Photo Slider Functionality
        const photoSliders = {};
        
        function initPhotoSlider(reviewId) {
            if (photoSliders[reviewId]) return; // Already initialized
            
            const sliderWrapper = document.getElementById(`slider-${reviewId}`);
            const prevBtn = document.querySelector(`.photo-slider-nav.prev[data-review-id="${reviewId}"]`);
            const nextBtn = document.querySelector(`.photo-slider-nav.next[data-review-id="${reviewId}"]`);
            const dots = document.querySelectorAll(`.photo-slider-dot[data-review-id="${reviewId}"]`);
            
            if (!sliderWrapper) return;
            
            let currentIndex = 0;
            const slides = sliderWrapper.querySelectorAll('.photo-slide');
            const totalSlides = slides.length;
            
            if (totalSlides <= 1) return; // No slider needed for single photo
            
            function updateSlider() {
                const translateX = -currentIndex * 100;
                sliderWrapper.style.transform = `translateX(${translateX}%)`;
                
                // Update dots
                dots.forEach((dot, index) => {
                    if (index === currentIndex) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
                
                // Update nav buttons
                if (prevBtn) prevBtn.disabled = currentIndex === 0;
                if (nextBtn) nextBtn.disabled = currentIndex === totalSlides - 1;
            }
            
            function goToSlide(index) {
                if (index < 0 || index >= totalSlides) return;
                currentIndex = index;
                updateSlider();
            }
            
            function nextSlide() {
                if (currentIndex < totalSlides - 1) {
                    goToSlide(currentIndex + 1);
                }
            }
            
            function prevSlide() {
                if (currentIndex > 0) {
                    goToSlide(currentIndex - 1);
                }
            }
            
            // Navigation buttons
            if (prevBtn) {
                prevBtn.addEventListener('click', prevSlide);
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', nextSlide);
            }
            
            // Dot navigation
            dots.forEach((dot, index) => {
                dot.addEventListener('click', () => goToSlide(index));
            });
            
            // Touch/swipe support
            let touchStartX = 0;
            let touchEndX = 0;
            
            sliderWrapper.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            sliderWrapper.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        nextSlide(); // Swipe left = next
                    } else {
                        prevSlide(); // Swipe right = prev
                    }
                }
            }
            
            // Initialize
            updateSlider();
            photoSliders[reviewId] = { goToSlide, nextSlide, prevSlide, currentIndex: () => currentIndex };
        }
        
        // Initialize all sliders on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.photo-slider-container').forEach(container => {
                const reviewId = container.getAttribute('data-review-id');
                if (reviewId) initPhotoSlider(reviewId);
            });
        });
        
        // Handle photo clicks - collect all photos from the same review
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('review-photo')) {
                e.preventDefault();
                e.stopPropagation();
                
                const clickedPhotoUrl = e.target.getAttribute('data-photo-url');
                const reviewId = e.target.getAttribute('data-review-id');
                
                // Find all photos from the same review
                const reviewCard = e.target.closest('.review-card');
                if (!reviewCard) return;
                
                const allPhotoElements = reviewCard.querySelectorAll('.review-photo');
                const photos = Array.from(allPhotoElements).map((img, index) => ({
                    url: img.getAttribute('data-photo-url'),
                    index: index
                }));
                
                const startIndex = photos.findIndex(p => p.url === clickedPhotoUrl);
                
                // Extract review data from the card
                const reviewData = {
                    author: reviewCard.querySelector('.reviewer-name')?.textContent || '',
                    date: reviewCard.querySelector('.review-date')?.textContent || '',
                    rating: reviewCard.querySelectorAll('.star').length || 5,
                    text: reviewCard.querySelector('.review-text')?.textContent || '',
                    verified: reviewCard.querySelector('.meta-badge.verified') !== null
                };
                
                openPhotoModal(clickedPhotoUrl, photos, startIndex >= 0 ? startIndex : 0, reviewData);
            }
        });
        
        // Modal slider navigation
        if (photoModalSliderPrev) {
            photoModalSliderPrev.addEventListener('click', showPrevPhoto);
        }
        
        if (photoModalSliderNext) {
            photoModalSliderNext.addEventListener('click', showNextPhoto);
        }
        
        // Dot navigation
        if (photoModalSliderDots) {
            photoModalSliderDots.addEventListener('click', function(e) {
                if (e.target.classList.contains('photo-modal-slider-dot')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    currentPhotoIndex = index;
                    updateModalSlider();
                }
            });
        }
        
        // Load More Reviews functionality
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (loadMoreBtn) {
            let currentOffset = {{ reviews|length }};
            const limit = 20;
            const totalCount = {{ total_count }};
            
            loadMoreBtn.addEventListener('click', async function() {
                if (this.disabled) return;
                
                this.disabled = true;
                this.textContent = 'Loading...';
                
                try {
                    const response = await fetch(`/widget/${shopId}/reviews/${productId}/api?offset=${currentOffset}&limit=${limit}&sort=${currentSort}`);
                    const data = await response.json();
                    
                    if (data.success && data.reviews) {
                        const reviewsContainer = document.querySelector('.reviews-container');
                        const loadMoreContainer = document.getElementById('load-more-container');
                        
                        data.reviews.forEach(review => {
                            const reviewCard = document.createElement('div');
                            reviewCard.className = 'review-card';
                            
                            let stars = '';
                            for (let i = 0; i < review.rating; i++) {
                                stars += '<span class="star">‚òÖ</span>';
                            }
                            
                            // Build photo slider HTML
                            let mediaHtml = '';
                            if (review.media && review.media.length > 0) {
                                const hasMultiple = review.media.length > 1;
                                mediaHtml = `
                                    <div class="review-media-slider">
                                        <div class="photo-slider-container" data-review-id="${review.id}">
                                            <div class="photo-slider-wrapper" id="slider-${review.id}">
                                                ${review.media.map(m => `
                                                    <div class="photo-slide">
                                                        <img src="${m.media_url}" alt="Review photo" loading="lazy" class="review-photo" data-photo-url="${m.media_url}" data-review-id="${review.id}">
                                                    </div>
                                                `).join('')}
                                            </div>
                                            ${hasMultiple ? `
                                                <button class="photo-slider-nav prev" data-review-id="${review.id}" aria-label="Previous photo">‚Äπ</button>
                                                <button class="photo-slider-nav next" data-review-id="${review.id}" aria-label="Next photo">‚Ä∫</button>
                                                <div class="photo-slider-dots" id="dots-${review.id}">
                                                    ${review.media.map((_, i) => `
                                                        <span class="photo-slider-dot ${i === 0 ? 'active' : ''}" data-index="${i}" data-review-id="${review.id}"></span>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Don't show "No photos" placeholder - just leave it empty (like Amazon/Etsy)
                                mediaHtml = '';
                            }
                            
                            let metaHtml = '';
                            if (review.verified) {
                                metaHtml += '<span class="meta-badge verified">‚úì Verified</span>';
                            }
                            
                            // Build helpful and share actions HTML
                            const helpfulHtml = `
                                <div class="helpful-section">
                                    <span class="helpful-label">Was this helpful?</span>
                                    <button class="helpful-btn" data-review-id="${review.id}" data-vote="yes" title="Yes, helpful">
                                        üëç <span class="helpful-count">${review.helpful_yes || 0}</span>
                                    </button>
                                </div>
                                <div class="share-section">
                                    <span style="color: #a7a1a1;">‚Ä¢ </span>
                                    <button class="share-btn" data-platform="facebook" data-review-id="${review.id}" title="Share on Facebook">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
                                    </button>
                                    <button class="share-btn" data-platform="twitter" data-review-id="${review.id}" title="Share on Twitter/X">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                                    </button>
                                    <button class="share-btn" data-platform="copy" data-review-id="${review.id}" title="Copy link">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                    </button>
                                </div>
                            `;
                            
                            reviewCard.innerHTML = `
                                <div class="review-content">
                                    <div class="review-header">
                                        <div class="reviewer-avatar">${(review.author || review.reviewer_name || 'C')[0]}</div>
                                        <div class="reviewer-info">
                                            <div class="reviewer-name">${review.author || review.reviewer_name || 'Anonymous'}</div>
                                            <div class="review-date">${review.date || review.review_date}</div>
                                            <div class="review-rating">
                                                ${stars}
                                                <span class="rating-number">(${review.rating})</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="review-text">${review.text || review.body || ''}</div>
                                    <div class="review-meta">${metaHtml}</div>
                                </div>
                                ${mediaHtml}
                                <div class="review-actions">
                                    ${helpfulHtml}
                                </div>
                            `;
                            
                            // Initialize slider for this review
                            if (review.media && review.media.length > 0) {
                                setTimeout(() => initPhotoSlider(review.id), 100);
                            }
                            
                            reviewsContainer.insertBefore(reviewCard, loadMoreContainer);
                        });
                        
                        currentOffset += data.reviews.length;
                        
                        // Check if there are more reviews
                        if (!data.has_more || currentOffset >= totalCount) {
                            loadMoreContainer.remove();
                        } else {
                            this.disabled = false;
                            this.textContent = 'Load More Reviews';
                        }
                        
                        resizeIframe();
                    } else {
                        console.error('Failed to load more reviews:', data);
                        this.disabled = false;
                        this.textContent = 'Load More Reviews';
                    }
                } catch (error) {
                    console.error('Error loading more reviews:', error);
                    this.disabled = false;
                    this.textContent = 'Load More Reviews';
                }
            });
        }
        
        // ==================== HELPFUL BUTTONS ====================
        document.addEventListener('click', function(e) {
            const helpfulBtn = e.target.closest('.helpful-btn');
            if (helpfulBtn) {
                e.preventDefault();
                const reviewId = helpfulBtn.dataset.reviewId;
                const vote = helpfulBtn.dataset.vote;
                
                // Check if already voted (stored in localStorage)
                const votedReviews = JSON.parse(localStorage.getItem('sakura_voted_reviews') || '{}');
                if (votedReviews[reviewId]) {
                    showToast('You already voted on this review');
                    return;
                }
                
                // Update UI immediately
                helpfulBtn.classList.add('voted');
                const countEl = helpfulBtn.querySelector('.helpful-count');
                if (countEl) {
                    countEl.textContent = parseInt(countEl.textContent || 0) + 1;
                }
                
                // Store in localStorage
                votedReviews[reviewId] = vote;
                localStorage.setItem('sakura_voted_reviews', JSON.stringify(votedReviews));
                
                // Send to server (fire and forget)
                fetch(`/api/reviews/${reviewId}/helpful`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: vote })
                }).catch(err => console.log('Helpful vote sent'));
                
                showToast('Thanks for your feedback!');
            }
        });
        
        // ==================== SHARE BUTTONS ====================
        document.addEventListener('click', function(e) {
            const shareBtn = e.target.closest('.share-btn');
            if (shareBtn) {
                e.preventDefault();
                const platform = shareBtn.dataset.platform;
                const reviewId = shareBtn.dataset.reviewId;
                
                // Get review text from the card
                const reviewCard = shareBtn.closest('.review-card');
                const reviewText = reviewCard?.querySelector('.review-text')?.textContent?.trim() || 'Check out this great review!';
                const reviewRating = reviewCard?.querySelectorAll('.star')?.length || 5;
                
                const pageUrl = window.location.href;
                const shareText = `${'‚òÖ'.repeat(reviewRating)} "${reviewText.substring(0, 100)}${reviewText.length > 100 ? '...' : ''}"`;
                
                if (platform === 'facebook') {
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}&quote=${encodeURIComponent(shareText)}`, '_blank', 'width=600,height=400');
                } else if (platform === 'twitter') {
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(pageUrl)}`, '_blank', 'width=600,height=400');
                } else if (platform === 'copy') {
                    navigator.clipboard.writeText(pageUrl).then(() => {
                        showToast('Link copied to clipboard!');
                    }).catch(() => {
                        showToast('Failed to copy link');
                    });
                }
            }
        });
        
        // ==================== TOAST NOTIFICATION ====================
        function showToast(message) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Mark already voted reviews on load
        document.addEventListener('DOMContentLoaded', function() {
            const votedReviews = JSON.parse(localStorage.getItem('sakura_voted_reviews') || '{}');
            Object.keys(votedReviews).forEach(reviewId => {
                const btn = document.querySelector(`.helpful-btn[data-review-id="${reviewId}"][data-vote="${votedReviews[reviewId]}"]`);
                if (btn) btn.classList.add('voted');
            });
        });
    </script>
</body>
</html>
